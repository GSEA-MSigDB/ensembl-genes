name: Build
on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      release:
        description: 'Ensembl release number'
        required: true
        default: '104'
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
    - name: Run pre-commit
      uses: pre-commit/action@v2.0.3
    - name: Install poetry
      run: pip install poetry
    - name: Install dependencies
      run: poetry install
    - name: Test with pytest
      run: poetry run pytest --color=yes
    - name: Extract tables
      id: extract
      if: github.event_name == 'workflow_dispatch'
      run: poetry run python src/ensembl_genes.py all --release=${{ github.event.inputs.release }}
    - name: Output artifact
      # upload outputs to artifact only when the extraction fails
      if: always() && steps.extract.outcome == 'failure'
      uses: actions/upload-artifact@v2
      with:
        name: failed-output-${{ github.event.inputs.release }}
        path: output/${{ github.event.inputs.release }}
    - name: Deploy
      if: github.event_name == 'workflow_dispatch'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: output-${{ github.event.inputs.release }}
        publish_dir: output/${{ github.event.inputs.release }}
        # https://github.com/peaceiris/actions-gh-pages/issues/660
        disable_nojekyll: true
